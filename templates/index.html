
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Timetable - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background:#f6f7fb; }
      .timetable { background:white; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
      .slot { border-radius:6px; padding:8px; margin:4px 0; cursor:pointer; }
      .time-col { width:110px; }
      .day-col { min-width:160px; }
      .slot.empty { border: 2px dashed #e6e9ef; height:64px; }
      .year-block { margin-bottom:28px; }
      .slot-controls { margin-top:8px; }
      .small-muted { font-size:0.85rem; color:#6c757d; }
      .slot .meta { font-size:0.85rem; color:#333; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Smart Classroom - Timetable Admin</h3>
        <div>
          <button id="generateBtn" class="btn btn-primary">Generate Timetable</button>
          <button id="downloadPdf" class="btn btn-outline-secondary">Download PDF</button>
        </div>
      </div>

      <div class="row">
        <div class="col-md-3">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Controls</h5>
              <p class="small-muted">Seeded sample data included. Use controls to add/edit records (prototype).</p>
              <button id="seedBtn" class="btn btn-sm btn-success mb-2">Reset & Seed Sample Data</button>
              <a href="/manage" class="btn btn-sm btn-outline-primary mb-2">Open Data Manager</a>
            </div>
          </div>

          <div class="card">
            <div class="card-body small-muted">
              <h6>Rules enforced on edit</h6>
              <ul>
                <li>No teacher double booking</li>
                <li>No classroom double booking</li>
                <li>Lab duration must be continuous</li>
                <li>Subject weekly lecture limits respected</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="col-md-9">
          <div id="timetableContainer">
            <!-- Timetables will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Slot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input type="hidden" id="slotId">
              <div class="mb-3">
                <label class="form-label">Day</label>
                <select id="day" class="form-select" required>
                  <option>MON</option>
                  <option>TUE</option>
                  <option>WED</option>
                  <option>THU</option>
                  <option>FRI</option>
                  <option>SAT</option>
                </select>
              </div>
              <div class="mb-3 row">
                <div class="col-6"><label class="form-label">Start (HH:MM)</label><input id="start" class="form-control" required></div>
                <div class="col-6"><label class="form-label">End (HH:MM)</label><input id="end" class="form-control" required></div>
              </div>
              <div class="mb-3">
                <label class="form-label">Year/Class</label>
                <select id="classYear" class="form-select"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Subject</label>
                <select id="subject" class="form-select"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Teacher</label>
                <select id="teacher" class="form-select"></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Classroom</label>
                <select id="classroom" class="form-select"></select>
              </div>
              <div id="editAlert" class="alert d-none" role="alert"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button id="saveEdit" class="btn btn-primary">Save</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      const DAYS = ['MON','TUE','WED','THU','FRI','SAT'];

      function loadTimetables(){
        $('#timetableContainer').html('<div class="text-center py-5">Loading...</div>');
        $.get('/api/timetables', function(resp){
          $('#timetableContainer').html('');
          resp.years.forEach(function(block){
            const el = renderYearBlock(block);
            $('#timetableContainer').append(el);
          });
        })
      }

      function renderYearBlock(block){
        const container = $('<div class="timetable year-block"></div>');
        container.append('<h5>'+block.year+' <small class="small-muted">('+block.classroom_name+')</small></h5>');
        const table = $('<div class="d-flex mt-2"></div>');
        const timeCol = $('<div class="time-col me-2"></div>');
        const times = block.times;
        times.forEach(t=> timeCol.append('<div class="small-muted mb-3" style="height:68px">'+t+'</div>'));
        table.append(timeCol);
        // days columns
        DAYS.forEach((d)=>{
          const col = $('<div class="day-col me-2"></div>');
          col.append('<div class="text-center small-muted mb-2">'+d+'</div>');
          times.forEach((t, idx)=>{
            const slot = block.grid[d] && block.grid[d][t] ? block.grid[d][t] : null;
            if(slot){
              const slotDiv = $('<div class="slot" data-slotid="'+slot.slot_id+'"></div>');
              slotDiv.css('background','#fff');
              slotDiv.append('<div><strong>'+slot.subject_name+'</strong></div>');
              slotDiv.append('<div class="meta">'+slot.teacher_name+' | '+slot.classroom_name+'</div>');
              slotDiv.on('click', function(){ openEdit(slot); });
              col.append(slotDiv);
            } else {
              const empty = $('<div class="slot empty" data-day="'+d+'" data-time="'+t+'">Click to add</div>');
              empty.on('click', function(){ openEmpty(d,t, block.year); });
              col.append(empty);
            }
          })
          table.append(col);
        })
        container.append(table);
        return container;
      }

      function openEmpty(day, time, year){
        // prepare modal for a new slot
        $('#slotId').val('');
        $('#day').val(day);
        const parts = time.split(' - ');
        $('#start').val(parts[0]); $('#end').val(parts[1]);
        populateSelects(function(){
          $('#classYear').val(year);
          $('#subject').val('');
          $('#teacher').val('');
          $('#classroom').val('');
          $('#editAlert').addClass('d-none');
          var modal = new bootstrap.Modal(document.getElementById('editModal'));
          modal.show();
        });
      }

      function openEdit(slot){
        $('#slotId').val(slot.slot_id);
        $('#day').val(slot.day);
        $('#start').val(slot.time_start); $('#end').val(slot.time_end);
        populateSelects(function(){
          $('#classYear').val(slot.class_year);
          $('#subject').val(slot.subject_id);
          $('#teacher').val(slot.teacher_id);
          $('#classroom').val(slot.classroom_id);
          $('#editAlert').addClass('d-none');
          var modal = new bootstrap.Modal(document.getElementById('editModal'));
          modal.show();
        });
      }

      function populateSelects(cb){
        $.get('/api/options', function(resp){
          const subj = $('#subject').empty();
          resp.subjects.forEach(s=> subj.append('<option value="'+s.subject_id+'">'+s.name+' ('+s.duration+'h)'+'</option>'));
          const teachers = $('#teacher').empty();
          resp.teachers.forEach(t=> teachers.append('<option value="'+t.teacher_id+'">'+t.name+'</option>'));
          const classes = $('#classYear').empty();
          resp.class_years.forEach(c=> classes.append('<option value="'+c+'">'+c+'</option>'));
          const rooms = $('#classroom').empty();
          resp.classrooms.forEach(r=> rooms.append('<option value="'+r.classroom_id+'">'+r.name+'</option>'));
          cb();
        })
      }

      $(function(){
        loadTimetables();

        $('#seedBtn').on('click', function(){
          $.post('/api/seed', {}, function(){ loadTimetables(); });
        });

        $('#generateBtn').on('click', function(){
          $.post('/api/generate', {}, function(){ loadTimetables(); });
        });

        $('#saveEdit').on('click', function(){
          const payload = {
            slot_id: $('#slotId').val(),
            day: $('#day').val(),
            time_start: $('#start').val(),
            time_end: $('#end').val(),
            class_year: $('#classYear').val(),
            subject_id: $('#subject').val(),
            teacher_id: $('#teacher').val(),
            classroom_id: $('#classroom').val()
          };
          $.post('/api/edit_slot', payload, function(resp){
            if(resp.status === 'ok'){
              loadTimetables();
              var modalEl = document.getElementById('editModal');
              var modal = bootstrap.Modal.getInstance(modalEl);
              modal.hide();
            } else {
              $('#editAlert').removeClass('d-none').addClass('alert-danger').text(resp.message);
            }
          })
        });

        $('#downloadPdf').on('click', function(){
          // capture the timetableContainer and create PDF
          const node = document.getElementById('timetableContainer');
          html2canvas(node, {scale:1.6}).then(canvas=>{
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p','pt','a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('timetable.pdf');
          });
        });
      })
    </script>
  </body>
</html>
